<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.title }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .header-title {
            text-align: left;
        }

        .info-table {
            width: 600px;
            border: 0px;
            table-layout: fixed; /* This ensures that all columns are of equal width */
            margin-bottom: 40px;
        }

        .info-table th, .info-table td {
            text-align: left;
            padding:0px;
        }

        .info-table th {
            color: #000000;
        }

        section {
            margin-bottom: 40px;
        }

        .property-table {
            width: 100%;
            table-layout: fixed; /* Ensures consistent column widths */
        }

        .property-table th:first-child, td:first-child {
            width: 66%;
        }

        .property-table th, td {
            width: 33.33%; /* Distributes width evenly across 3 columns */
            text-align: left;
            padding: 8px;
        }

        .property-table th {
            background-color: #333; /* Dark background for header */
            color: #fff; /* White text for header */
        }

        .property-table tr:nth-child(even) {
            background-color: #f2f2f2; /* Light grey for even rows */
        }

        #identity .identity-content {
            display: flex;
            align-items: flex-start;  /* This ensures top alignment */
        }

    </style>
</head>
<body>
    <h1 class="header-title">Reproductive Hazard Assessment</h1>
    <table class="info-table">
        <tr>
            <th>Generated</th>
            <th>Type</th>
            <th>Version</th>
        </tr>
        <tr>
            <td>{{ report.generated_on }}</td>
            <td>Reproductive Toxicity</td>
            <td>1.0</td>
        </tr>
    </table>
    <hr>
    <section id="identity">
        <h2>Identity</h2>
        <p>InChI: {{ report.inchi }}</p>
        <p>SMILES: {{ report.smiles }}</p>
    </section>
    <hr>
    <!-- Dynamically generate sections for each category -->
    {% for category in ['reproductive toxicity', 'developmental toxicity', 'endocrine disruption'] %}
        {% set total = grouped_data[category] | length %}
        {% set known_positives = grouped_data[category] | selectattr('value', 'equalto', 'positive') | list | length %}
        {% set predicted_positives = grouped_data[category] | selectattr('value', 'equalto', 'unknown') | selectattr('prediction', 'gt', 0.5) | list | length %}
        {% set known_or_predicted_positive = known_positives + predicted_positives %}
        {% set known_or_predicted_positive_percent = (known_or_predicted_positive / total * 100) | round(2) %}
        {% if category in grouped_data %}
            <h2>{{ category | title }}</h2>
            

            For the given substance, {{ known_or_predicted_positive }} out of {{ total }} ( {{ known_or_predicted_positive_percent }}% ) {{category | title}} properties are known or predicted to be positive:
            <ul>
                <li>{{ known_positives }} Known positives</li>
                <li>{{ grouped_data[category] | selectattr('value', 'equalto', 'negative') | list | length }} Known negatives</li>
                <li>{{ predicted_positives }} Unknowns predicted to be positive </li>
                <li>{{ grouped_data[category] | selectattr('value', 'equalto', 'unknown') | selectattr('prediction', 'lt', 0.5) | list | length }} Unknowns predicted to be negative</li>
            </ul>
            
            {% if known_or_predicted_positive > 0 %}
            These known or predicted positive properties include:
            <br><br>
            <table class="property-table">
                <tr>
                    <th>Title</th>
                    <th>Known Value</th>
                    <th>Prediction (%)</th>
                </tr>
                {% for prediction in grouped_data[category] | sort(attribute='prediction', reverse=true) %}
                    {% if prediction.value == 'positive' or (prediction.prediction > 0.5 and prediction.value != 'negative') %}
                        <tr>
                            <td>{{ prediction.title }}</td>
                            <td>{{ prediction.value }}</td>
                            {% if prediction.value != 'positive' %}
                                <td>{{ '%0.1f'|format(prediction.prediction * 100) }}</td>
                            {% endif %}
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
            {% endif %}
            <hr>
        {% endif %}
    {% endfor %}
</body>
<script>
    // Assuming the report object is passed as a JSON string
    const report = {{ report | tojson | safe }};
    const grouped_data = {{ grouped_data | tojson | safe }};
</script>
</html>
