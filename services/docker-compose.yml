version: '3'
services:

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - toxindex-data:/data
    ports:
      - 5415:5432

  nginx:
    image: nginx:latest
    ports:
      - "80:80" # Expose Nginx on port 80 of the host
    volumes:
      - ./nginx:/etc/nginx/conf.d # Mount custom Nginx configuration directory
    depends_on:
      - webserver
      - report
      - search

  flyway:
    image: flyway/flyway
    command: -url=jdbc:postgresql://postgres:5432/${DB_NAME} -user=${DB_USER} -password=${DB_PASSWORD} -connectRetries=60 migrate
    volumes:
      - ./flyway/sql:/flyway/sql
    depends_on:
      - postgres

  webserver:
    build:
      context: ./webserver
    ports:
      - "6513:6513"
    volumes:
      - ./webserver/webserver:/webserver
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_TEST_SECRET_KEY: ${STRIPE_TEST_SECRET_KEY}
      WEBSERVER_SERVER_NAME: ${WEBSERVER_SERVER_NAME}
      WEBSERVER_PREFERRED_URL_SCHEME: ${WEBSERVER_PREFERRED_URL_SCHEME}
      FLASK_APP_SECRET_KEY: ${FLASK_APP_SECRET_KEY}
    depends_on:
      - postgres
      - flyway
  
  report:
    build:
      context: ./report
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME}
    ports:
      - "6516:6515"
    volumes:
      - ./report:/report
    depends_on:
      - postgres
      - flyway
  
  search:
    build:
      context: ./search
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
    ports:
      - "6515:6515"
    volumes:
      - ./search:/search
    depends_on:
      - postgres
      - flyway
    
volumes:
  toxindex-data:
