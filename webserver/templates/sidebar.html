<div class="sidebar">
    <div class="platform-title">
        <span style="font-size:1.7rem; font-weight:900; color:#22c55e; margin-right:8px;">T</span>
        <a href="/" style="text-decoration: none; color: var(--text-color);">Toxindex</a>
        <button id="sidebar-collapse-btn" class="collapse-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    
    <div class="tasks" id="env-list">
        <div id="add-env-container" class="mb-3">
            <button id="add-env-btn" type="button" class="new-env-btn d-flex align-items-center gap-2 w-100" style="background: none; border: none; color: #fff; font-size: 1.08rem; font-weight: 400; padding: 0; box-shadow: none; min-height: 36px;">
                <span class="icon-folder-plus" style="display: flex; align-items: center;">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="#fff" stroke-width="2"/>
                    <g>
                      <circle cx="6.5" cy="17.5" r="2" fill="#181c1f"/>
                      <path d="M6.5 16v3M5 17.5h3" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round"/>
                    </g>
                  </svg>
                </span>
                <span style="color: #fff;">New environment</span>
            </button>
            <input id="add-env-input" type="text" class="form-control mt-2" placeholder="New environment name" style="display:none;" />
        </div>
        {% for env in environments %}
        <div class="task-item" data-id="{{ env.environment_id }}">
            <span>{{ env.title }}</span>
            <button class="delete-env-btn" data-id="{{ env.environment_id }}" title="Delete Environment">X</button>
        </div>
        {% endfor %}
    </div>
    
    <div class="sidebar-footer">
        <a href="/logout" class="logout-button">Logout</a>
    </div>
</div>

<script>
    // DOM elements
    const envList = document.getElementById('env-list');
    const sidebar = document.querySelector('.sidebar');
    const collapseBtn = document.getElementById('sidebar-collapse-btn');
    const mainContent = document.querySelector('.container .main');
    
    // Collapse functionality
    collapseBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        if (mainContent) {
            mainContent.classList.toggle('expanded');
        }
        // Rotate collapse button icon
        collapseBtn.querySelector('svg').style.transform = 
            sidebar.classList.contains('collapsed') ? 'rotate(180deg)' : '';
    });

    // Load environment items
    document.querySelectorAll('.task-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-env-btn')) {
                return;
            }
            loadEnvironment(this.dataset.id);
        });
    });

    function loadEnvironment(id) {
        window.location.href = `/environment/${id}`;
    }

    function loadEnvironments() {
        fetch('/environments')
        .then(response => response.json())
        .then(data => {
            if (data.environments) {
                const addEnvHTML = document.getElementById('add-env-container')?.outerHTML || '';
                envList.innerHTML = '';
                // Re-insert add-env-container HTML as first child
                envList.insertAdjacentHTML('afterbegin', addEnvHTML);
                data.environments.forEach(env => {
                    const item = document.createElement('div');
                    item.classList.add('task-item');
                    item.dataset.id = env.environment_id;

                    const title = document.createElement('span');
                    title.textContent = env.title;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-env-btn');
                    deleteBtn.dataset.id = env.environment_id;
                    deleteBtn.textContent = 'X';
                    deleteBtn.title = 'Delete Environment';

                    item.appendChild(title);
                    item.appendChild(deleteBtn);

                    item.addEventListener('click', function(e) {
                        if (e.target.classList.contains('delete-env-btn')) {
                            return;
                        }
                        loadEnvironment(env.environment_id);
                    });

                    envList.appendChild(item);
                });
                // Re-attach add environment button/input listeners
                const addEnvBtn = document.getElementById('add-env-btn');
                const addEnvInput = document.getElementById('add-env-input');
                if (addEnvBtn && addEnvInput) {
                    addEnvBtn.onclick = () => {
                        addEnvBtn.style.display = 'none';
                        addEnvInput.style.display = 'block';
                        addEnvInput.focus();
                    };
                    addEnvInput.onkeydown = function(e) {
                        if (e.key === 'Enter') {
                            const name = addEnvInput.value.trim();
                            if (!name) return;
                            fetch('/environment/new', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ title: name })
                            })
                            .then(r => r.json())
                            .then(data => {
                                if (data.environment_id) {
                                    addEnvInput.value = '';
                                    addEnvInput.style.display = 'none';
                                    addEnvBtn.style.display = 'block';
                                    loadEnvironments();
                                }
                            });
                        } else if (e.key === 'Escape') {
                            addEnvInput.value = '';
                            addEnvInput.style.display = 'none';
                            addEnvBtn.style.display = 'block';
                        }
                    };
                }
            }
        })
        .catch(error => console.error('Error loading environments:', error));
    }

    // Load environments when the page loads
    document.addEventListener('DOMContentLoaded', loadEnvironments);

    // Add these styles to your CSS
    const style = document.createElement('style');
    style.textContent = `
        .platform-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 10px;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--text-color);
            transition: transform 0.3s ease;
        }
        
        .collapse-btn:hover {
            opacity: 0.8;
        }
        
        .sidebar {
            transition: width 0.3s ease;
            width: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(155, 155, 155, 0.5) transparent;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background-color: rgba(155, 155, 155, 0.5);
            border-radius: 3px;
            border: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(155, 155, 155, 0.8);
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar.collapsed .tasks,
        .sidebar.collapsed .sidebar-footer,
        .sidebar.collapsed .platform-title a {
            display: none;
        }
        
        .main {
            transition: margin-left 0.3s ease;
        }
        
        .main.expanded {
            margin-left: 60px;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .task-item span {
            padding-right: 12px;
        }
        
        .delete-env-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-color, #333);
            cursor: pointer;
            font-size: 1em;
            padding: 2px 6px;
            margin-left: 0;
        }
        
        .task-item:hover .delete-env-btn {
            display: inline;
        }
        
        .delete-env-btn:hover {
            color: red;
        }
    `;
    document.head.appendChild(style);

    envList.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-env-btn')) {
            e.stopPropagation();
            const envId = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this environment?')) {
                fetch(`/environment/${envId}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            loadEnvironments();
                        } else {
                            alert('Failed to delete environment.');
                        }
                    });
            }
        }
    });
</script>
