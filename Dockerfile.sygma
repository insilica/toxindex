# General worker image for standard tasks (probra, openai, etc.)
FROM toxindex-base:latest

# Become root for system package install
USER root
ENV DEBIAN_FRONTEND=noninteractive PIP_NO_CACHE_DIR=1

# System libs needed by Pillow and RDKit drawing
# (and create apt lists dir so non-root base layers don't block update)
RUN mkdir -p /var/lib/apt/lists/partial && chmod -R 0755 /var/lib/apt/lists && \
    apt-get update && apt-get install -y --no-install-recommends \
      build-essential gcc g++ make \
      zlib1g-dev libjpeg62-turbo-dev libpng-dev libtiff5-dev libfreetype6-dev \
      liblcms2-dev libwebp-dev libopenjp2-7-dev \
      libharfbuzz-dev libfribidi-dev libxcb1-dev \
      libxrender1 libxext6 libsm6 libx11-6 libexpat1 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Set working directory inside the container
WORKDIR /app


COPY workflows/celery_worker_sygma.py    workflows/celery_worker_sygma.py
COPY workflows/metabolite_sygma_task.py  workflows/metabolite_sygma_task.py


# SyGMa docker helper files and tool source
COPY workflows/sygma_docker/             workflows/sygma_docker/
COPY sygma/metabolite-sygma/                   metabolite-sygma/

# Install RDKit first (required by sygma package setup)
RUN pip install rdkit==2024.9.5

# Then install the metabolite-sygma package
RUN pip install ./metabolite-sygma/

USER app
# Entrypoint: Celery worker for metabolite-sygma tasks only
CMD ["python", "-m", "celery", "-A", "workflows.celery_worker_sygma.celery", "worker", "--loglevel=info", "-Q", "sygma"]